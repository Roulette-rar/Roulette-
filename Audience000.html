<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ルーレット - 観客表示</title>
<style>
body {
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
  display:flex; align-items:center; justify-content:center;
  min-height:100vh; margin:0; background:#f3f6fb;
}
.wrap {
  width:420px; text-align:center; background:white;
  padding:18px; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.08);
  position: relative;
}
.wheel {
  width:360px; height:360px; margin:10px auto; position:relative;
  border-radius:50%; overflow:hidden; border:6px solid #222;
  background: conic-gradient(#f1c40f,#e74c3c,#3498db,#2ecc71,#9b59b6,#e67e22,#16a085,#2980b9);
  transition: transform 4s cubic-bezier(.12,.9,.18,1);
}
.pointer {
  position:absolute; left:50%; top:-18px; transform:translateX(-50%);
  width:0;height:0;border-left:18px solid transparent;
  border-right:18px solid transparent;border-bottom:28px solid #c0392b;
  z-index:3;
}
.center {
  position:absolute; left:50%; top:50%;
  transform:translate(-50%,-50%);
  width:200px; height:200px; border-radius:50%;
  background:rgba(255,255,255,0.95);
  display:flex; align-items:center; justify-content:center;
  font-weight:900; font-size:96px;
  z-index:2;
}
.labels {display:none;}
#remainingText {margin-top:6px; font-size:16px; color:#333;}
button#audience-spin {
  margin-top:15px; padding:8px 16px;
  font-size:18px; border:none; border-radius:6px;
  background:#3498db; color:white; cursor:pointer;
}
button#audience-spin:hover { background:#2980b9; }
</style>
</head>
<body>
<div class="wrap">
  <div style="position:relative;">
    <div class="pointer" aria-hidden="true"></div>
    <div id="wheel" class="wheel" aria-hidden="true"></div>
    <div id="center" class="center">—</div>
  </div>
  <div id="remainingText">残り: 読み込み中…</div>
  <button id="audience-spin">ルーレット開始</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getDatabase, ref, onValue, get, child, set } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

const firebaseConfig = { 
apiKey: "AIzaSyA1LnpXvoaTGbzQdOlAkcOPXW-8vrcnYxU",
authDomain: "roulette-7ee9d.firebaseapp.com",
databaseURL: "https://roulette-7ee9d-default-rtdb.firebaseio.com",
projectId: "roulette-7ee9d",
storageBucket: "roulette-7ee9d.firebasestorage.app",
messagingSenderId: "657226901613",
appId: "1:657226901613:web:1cceee27d98d0866223764",
measurementId: "G-576DS7K0SG" };

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
getAuth(app); // 認証はcontrollerと同じユーザーでログイン済みが前提

const N = 37;
const wheel = document.getElementById('wheel');
const center = document.getElementById('center');
const remainingText = document.getElementById('remainingText');

let animating = false;
let currentRotation = 0;

const nextRef = ref(db,'nextResult');
const remainingRef = ref(db,'remaining');

onValue(remainingRef, snap=>{
  const val = snap.val();
  const arr = Array.isArray(val)? val : Object.values(val||{}).filter(x=>x!=null);
  remainingText.textContent = arr.length>0 ? `残り: ${arr.join(', ')}` : '残りなし';
});

onValue(nextRef, snap=>{
  const val = snap.val();
  if(val===null || val<1 || val>N) return;
  spinToNumber(val);
});

function spinToNumber(targetNum){
  if(animating) return;
  animating = true;
  center.textContent='…';
  const anglePer = 360/N;
  const index = targetNum-1;
  const targetAngleForIndex = index*anglePer + anglePer/2;
  const extraRounds = 6 + Math.floor(Math.random()*3);
  const finalRotation = 360*extraRounds + (360 - targetAngleForIndex);

  wheel.style.transition='transform 4.5s cubic-bezier(.12,.9,.18,1)';
  wheel.getBoundingClientRect();
  wheel.style.transform=`rotate(${finalRotation}deg)`;
  currentRotation = finalRotation % 360;

  function onEnd(){
    wheel.removeEventListener('transitionend', onEnd);
    setTimeout(()=>{
      wheel.style.transition='transform 0.6s ease-out';
      wheel.style.transform=`rotate(${currentRotation}deg)`;
      wheel.addEventListener('transitionend', function tidy(){
        wheel.removeEventListener('transitionend', tidy);
        center.textContent=String(targetNum);
        animating=false;
      });
    },80);
  }
  wheel.addEventListener('transitionend', onEnd);
}
center.textContent='-';

// ルーレット開始ボタン
document.getElementById('audience-spin').addEventListener('click', async () => {
  // 1. forcedNext を確認
  const forcedSnap = await get(child(ref(db), 'forcedNext'));
  if (forcedSnap.exists() && forcedSnap.val() !== null) {
    const forcedVal = forcedSnap.val();
    await set(ref(db,'nextResult'), forcedVal);
    await set(ref(db,'forcedNext'), null);
    // 残数から削除
    const remSnap = await get(child(ref(db), 'remaining'));
    if (remSnap.exists()) {
      const arr = remSnap.val();
      const idx = arr.indexOf(forcedVal);
      if (idx > -1) {
        arr.splice(idx,1);
        await set(ref(db,'remaining'), arr);
      }
    }
    return;
  }

  // 2. 通常ランダム
  const remSnap = await get(child(ref(db), 'remaining'));
  if (!remSnap.exists()) { alert("残りがありません"); return; }
  const arr = remSnap.val();
  if (!Array.isArray(arr) || arr.length === 0) { alert("残りがありません"); return; }
  const idx = Math.floor(Math.random() * arr.length);
  const selected = arr[idx];
  await set(ref(db, 'nextResult'), selected);
  arr.splice(idx,1);
  await set(ref(db,'remaining'), arr);
});
</script>
</body>
</html>